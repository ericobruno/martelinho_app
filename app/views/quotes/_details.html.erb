<div id="quote_details">
  <div class="row">
    <!-- Quote Information -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle"></i>
            Informações do Orçamento
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Cliente</h6>
              <p class="mb-3">
                <%= link_to quote.customer.name, customer_path(quote.customer), 
                    class: "text-decoration-none fw-bold" %>
              </p>
              
              <% if quote.vehicle %>
                <h6 class="text-muted mb-1">Veículo</h6>
                <p class="mb-3">
                  <%= link_to "#{quote.vehicle.license_plate} - #{quote.vehicle.vehicle_brand.name} #{quote.vehicle.vehicle_model.name}", 
                      vehicle_path(quote.vehicle), class: "text-decoration-none fw-bold" %>
                </p>
              <% end %>
              
              <h6 class="text-muted mb-1">Data de Criação</h6>
              <p class="mb-0"><%= quote.created_at.strftime("%d/%m/%Y às %H:%M") %></p>
            </div>
            
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Status</h6>
              <p class="mb-3" id="quote_status_<%= quote.id %>">
                <%= render "quotes/status_badge", quote: quote %>
              </p>
              
              <h6 class="text-muted mb-1">Valor Total</h6>
              <p class="mb-3 fs-4 fw-bold text-primary">
                <%= quote.formatted_total %>
              </p>
              
              <% if quote.status == 'approved' %>
                <%= link_to "Criar Ordem de Serviço", new_quote_work_order_path(quote), 
                    class: "btn btn-success" %>
              <% end %>
            </div>
          </div>
          
          <% if quote.notes.present? %>
            <hr>
            <h6 class="text-muted mb-1">Descrição</h6>
            <p class="mb-0"><%= simple_format(quote.notes) %></p>
          <% end %>
        </div>
      </div>

      <!-- Quote Items -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-wrench"></i>
            Serviços do Orçamento
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Valor do Serviço</h6>
              <p class="fs-4 fw-bold text-primary mb-0">
                <%= quote.formatted_service_value %>
              </p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Total do Orçamento</h6>
              <p class="fs-4 fw-bold text-success mb-0">
                <%= quote.formatted_total %>
              </p>
            </div>
          </div>
          
          <% if quote.quote_items.any? %>
            <hr>
            <h6 class="text-muted mb-3">Itens Detalhados</h6>
            
            <!-- Desktop Table View -->
            <div class="d-none d-md-block">
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Serviço</th>
                      <th scope="col" class="text-center">Qtd</th>
                      <th scope="col" class="text-end">Valor Unit.</th>
                      <th scope="col" class="text-end">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% quote.quote_items.each do |item| %>
                      <tr>
                        <td><%= item.service_type.name %></td>
                        <td class="text-center"><%= item.quantity %></td>
                        <td class="text-end">
                          R$ <%= number_with_delimiter(item.unit_price_cents / 100.0, delimiter: '.', separator: ',') %>
                        </td>
                        <td class="text-end fw-bold">
                          R$ <%= number_with_delimiter(item.total_price_cents / 100.0, delimiter: '.', separator: ',') %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Mobile Card View -->
            <div class="d-md-none">
              <% quote.quote_items.each do |item| %>
                <div class="card mb-2">
                  <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <strong><%= item.service_type.name %></strong>
                        <br>
                        <small class="text-muted">Qtd: <%= item.quantity %></small>
                      </div>
                      <div class="text-end">
                        <div class="fw-bold">
                          R$ <%= number_with_delimiter(item.total_price_cents / 100.0, delimiter: '.', separator: ',') %>
                        </div>
                        <small class="text-muted">
                          R$ <%= number_with_delimiter(item.unit_price_cents / 100.0, delimiter: '.', separator: ',') %> cada
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Actions Sidebar -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-cogs"></i>
            Ações
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2" id="quote_actions_<%= quote.id %>">
            <% if quote.aberto? %>
              <%= link_to edit_quote_path(quote), class: "btn btn-outline-primary" do %>
                <i class="fas fa-edit"></i> Editar Orçamento
              <% end %>
            <% end %>
            
            <!-- Botão de aprovar para TODOS os orçamentos (exceto já aprovados) -->
            <% unless quote.aprovado? %>
              <button type="button" 
                      class="btn btn-success" 
                      data-controller="feedback"
                      data-feedback-loading-text-value="Aprovando..."
                      data-feedback-success-text-value="Aprovado!"
                      data-bs-toggle="modal" 
                      data-bs-target="#approveQuoteModal"
                      data-quote-id="<%= quote.id %>"
                      data-customer-name="<%= quote.customer.name %>"
                      data-vehicle-info="<%= quote.vehicle.license_plate %> - <%= quote.vehicle.vehicle_brand.name %> <%= quote.vehicle.vehicle_model.name %>"
                      data-quote-value="<%= quote.formatted_total %>">
                <i class="fas fa-check" data-feedback-target="icon"></i> 
                <span data-feedback-target="text">Aprovar</span>
              </button>
            <% end %>
            
            <% if quote.enviado? && !quote.expired? %>
              <%= button_to reject_quote_path(quote), method: :patch, 
                  confirm: "Tem certeza que deseja rejeitar este orçamento?", 
                  class: "btn btn-outline-danger" do %>
                <i class="fas fa-times"></i> Rejeitar
              <% end %>
            <% end %>
            
            <% if quote.aprovado? %>
              <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Orçamento Aprovado</strong>
                <% if quote.approved_at %>
                  <br><small>em <%= quote.approved_at.strftime("%d/%m/%Y às %H:%M") %></small>
                <% end %>
              </div>
              
              <% if quote.work_orders.any? %>
                <%= link_to work_order_path(quote.work_orders.last), class: "btn btn-outline-success" do %>
                  <i class="fas fa-tools"></i> Ver Ordem de Serviço
                <% end %>
              <% end %>
            <% end %>
            
            <% if quote.rejeitado? || quote.cancelado? || quote.expirado? %>
              <div class="alert alert-secondary">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Orçamento <%= quote.status.capitalize %></strong>
              </div>
            <% end %>
            
            <hr>
            
            <% if quote.aberto? || quote.enviado? %>
              <%= link_to quote_path(quote), method: :delete, 
                  confirm: "Tem certeza que deseja excluir este orçamento?", 
                  class: "btn btn-outline-danger" do %>
                <i class="fas fa-trash"></i> Excluir
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 